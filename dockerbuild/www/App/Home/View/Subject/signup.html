<extend name='Public/base'/>
<block name='style'>
<link rel="stylesheet" href="__PUBLIC__/home/css/register.css">
<style>
    body{background-color: #f5f5f5 !important;}
    .input-field input,select{width: 300px;}
    .vali-b .input-line .input-field { margin-left: 117px;}
    .vali-b .input-line b {width: 103px;    margin-top: 4px;}
    .input-line { margin: 0 auto 20px 0px;}
    .input-field input{height: 35px;}
    .input-field select{position: relative;width:321px;height:37px;padding:0 10px;line-height:28px;border:1px solid #d0d0d0;outline:none;font-size:14px;color:#212121;/*border-radius:5px;*/background:transparent;}
    .input-field select:focus{border-color:#2f8dd7;outline:none;}
    .button-div{
        width: 121px;
        height: 40px;
        line-height: 3;
        background: #D14E4E;
        border-radius: 6px;
        margin: 31px;
    }
    .button-div span {
        font-size: 14px;
        font-family: MicrosoftYaHei;
        color: #FFFFFF;
        line-height: 40px;
        display: block;
        height: 100%;
        width: 100%;
        text-align: center;
        }
    </style>
</block>
<block name='body' >
    <div class="main" style="padding: 27px 75px;width:930px;margin: 25px auto;">

    <form id='form' name='form' action="">
		<div class="vali-main" style="height:730px;">
            <div style="text-align: center;background: #EFEFEF;color: #D14E4E;height: 40px;font-size: 22px;line-height: 37px;"><span>{$subject.title}</span></div>
			<input type="hidden" name='sid' id='sid' value='{$subject.id}'>
			<div id="vali1" class="vali-b" style="width:480px;margin: 30px auto 70px auto;">
				<div class="input-line">
					<b><i class="red-need">*</i>手机号码</b>
					<div class="input-field"><input value='{$tel}' maxlength="11" readonly type="text" id="tel" name="tel"  placeholder="请输入手机号"  data-text="(+86)13800000000" class="need-text"    style="float: left;margin-right: 10px;"/></div>
				</div>
                <div class="input-line">
                    <b><i class="red-need">*</i>姓名</b>
                    <div class="input-field"><input type="text" id="name" maxlength="18" name="name"  placeholder="您的姓名" data-text="您的姓名" class="need-text" req="true" style="float: left;margin-right: 10px;"/></div>
                </div>
                <!-- <div class="input-line">
                    <b><i class="red-need">*</i>证件类型</b>
                    <div class="input-field">
                    <select name="ID_type" id="ID_type" style="float: left;margin-right: 10px;" calss='need-text'>
                        <option value="1">身份证</option>
                        <option value="2">护照</option>
                        <option value="3">台胞证</option>
                    </select>
                    </div>

                </div> -->
                <div class="input-line">
                    <b><i class="red-need">*</i>身份证号码</b>
                    <div class="input-field" style='z-index: 1;'><input type="text" maxlength="18" id="ID_num" name='ID_num' placeholder="身份证号码" data-text="身份证号码" class="need-text" style="float: left;margin-right: 10px;"/></div>
                    <div  class="input-field" style='z-index:0;font-size:  11px;width: 325px;line-height: 2;color: #949393;'>身份证号码一旦提交将不可更改。请确认填写的内容,此证件号只用于报名使用，不会泄露相关内容且不会涉及其他用途！                    </div>
                </div>
                <div class="input-line">
                    <b><i class="red-need">*</i>省份</b>
                    <div class="input-field">
                    <input name="province" type='hidden' value='' id='province_text'>
                    <select  id="province" style="float: left;margin-right: 10px;" calss='need-text'>
                        <option value="">请选择你的省份</option>
                        <volist name='provinces' id='vo'>
                            <option data-value='{$vo.dic_value}' class='province_{$vo.id}' value="{$vo.id}">{$vo.dic_value}</option>
                        </volist>
                    </select>
                    </div>

                </div>
                <div class="input-line">
                    <b><i class="red-need">*</i>城市</b>
                    <div class="input-field">
                    <select name="city" id="city" style="float: left;margin-right: 10px;" calss='need-text'>
                        <option value="">请选择你的城市</option>
                    </select>
                    </div>

                </div>
                <div class="input-line">
                    <b>邮箱</b>
                    <div class="input-field"><input type="text" id="email" maxlength="20" name="email"  placeholder="邮箱"  class="need-text" req="true" style="float: left;margin-right: 10px;"/></div>
                </div>
                <div class="input-line">
                    <b>毕业学校</b>
                    <div class="input-field"><input type="text" maxlength="50" id="scholl" name="school"  placeholder="毕业学校"class="need-text" req="true" style="float: left;margin-right: 10px;"/></div>
                </div>
                <div class="input-line">
                    <b>工作单位</b>
                    <div class="input-field"><input maxlength="50" type="text" id="company" name="company"  placeholder="工作单位" data-text="工作单位" class="need-text" req="true" style="float: left;margin-right: 10px;"/></div>
                </div>
                <div class="input-line">
                    <div class="input-field"><input type="checkbox" name='yhxy' checked class="check">同意<a id="protocol" target="_blank" href="{:U('Aboutus/index',array('t'=>'yhxy'))}">《工业大数据用户协议》</a></div>
                </div>
				<div class="input-line" style="margin: 0 160px;">
                    <div class='button-div right' id="nextBtn">
                        <a href="javascript:;" target="_blanck" ><span >提&nbsp; &nbsp;&nbsp;交</span></a>
                    </div>
				</div>
			</div>

		</div>
    </form>

    </div>
</block>
<block name='script'>
    <script src='__PUBLIC__/home/js/layer/layer.js'></script>
<script >
 $(function(){
     //提交事件
    $('#nextBtn').on('click',function(event){
        if(!checkForm()){
            return false;
        }
        $.ajax({
            url:"{:U('saveMember')}",
            type:'post',
            data:$('#form').serialize(),
            success:function(res){
                var res = $.parseJSON(res);
                if(res.success == true){
                    // layer.msg(res.msg);
                    $('#nextBtn').unbind().css('background','gray');
//                    layer.msg(res.msg,{
//                        time:500
//                    },function(){
//                        window.location.href = "{:U('Personinfo/index')}";
//                    });
                    var tipcontent = {
                        'popupContentTitle':'恭喜您报名成功!',
                        'firsttip':'凭借手机号登录大赛网站<a href="{:u("Home/Index/index")}">shaangu.maidiyun.com</a>，可查看报名信息、竞赛作品提交。',
                        'secondtip':'您已是设计宝用户，可直接登录<a href="http://www.maidiyun.com/help/mdsjb.html" target="_blank">今日制造</a>建立设计群组，进行技术交流。',
                        'thirdtip':'再次感谢对本次大赛的鼎力支持，预祝您比赛顺利，金榜题名！',
                        'btn':'<a href="/personinfo">好，去个人中心</a>',
                    };
                    openPopup(tipcontent,2);
                }else{
                    layer.msg(res.msg);
                }
            }
        })
    })
     //省市联动
    $('#province').on('change',function(){
        var province = $(this).val();
        var value = $('.province_'+province).data('value');
        $('#province_text').val(value);
        getCitys(province);
    })
})
    //验证表单
    function checkForm(){
        var tel = $('#tel').val();
        var sid = $('#sid').val();
        if(!tel){
            layer.msg('请输入手机号');
            $('#tel').focus();
            return false;
        }
        if(!checkTel(tel)){
            layer.msg('手机号格式错误');
            $('#tel').focus();
            return false;
        }
        var ok = true;
        $.ajax({
            url:'{:U(checkRepeat)}',
            data:{'value':tel,'key':'tel','sid':sid},
            type:'post',
            async:false,
            success:function(res){
                if($.parseJSON(res) == false){
                    layer.msg('您的手机号已经报名该题目');
                    ok = false;
                }
            }
        })
        if(!ok){
            return false;
        }
        if(!$.trim($('#name').val())){
            layer.msg('请输入姓名');
            $('#name').focus();
            return false;
        }
        var nreg = /^[a-zA-Z\u4e00-\u9fa5]+$/;
        if(!nreg.test($('#name').val())){
            $('#name').focus();
                layer.msg('姓名只能输入汉字和英文');
                return false;
        }
        // var ID_type = $('#ID_type').val();
        // if(!ID_type){
        //     layer.msg('请选择证件类型');
        //     $('#ID_type').focus();
        //     return false;
        // }
        var num = $.trim($('#ID_num').val());
        if(!num){
            layer.msg('请输入身份证号码');
            $('#ID_num').focus();
            return false;
        }
        if(!checkIdentity(num)){
            layer.msg('身份证格式错误');
            $('#ID_num').focus();
            return false;
        }
        // if(ID_type == 1){
        // }else if(ID_type == 2){
        //     if(!checkPassport(num)){
        //         layer.msg('护照格式错误');
        //         $('#ID_num').focus();
        //         return false;
        //     }
        // }else if(ID_type == 3){
        //     var reg = /^(\d{10}\(B\)|[0-9]{8}|[0-9]{10})$/;
        //     if(!reg.test(num)){
        //         $('#ID_num').focus();
        //         layer.msg('台胞证格式不正确');
        //         return false;
        //     }
        // }
        $.ajax({
            url:'{:U(checkRepeat)}',
            data:{'value':num,'key':'ID_num','sid':sid},
            type:'post',
            async:false,
            success:function(res){
                if($.parseJSON(res) == false){
                    $('#ID_num').focus();
                    layer.msg('您的身份证号已经报名该题目');
                    ok = false;
                }
            }
        })
        if(!ok){
            return false;
        }
        var province = $('#province').val();
        if(!province){
            $('#province').focus();
            layer.msg('请选择省份');
            return false;
        }
        var city = $('#city').val();
        if(!city){
            $('#city').focus();
            layer.msg('请选择城市');
            return false;
        }
        var email = $.trim($('#email').val());
        if(email){
//            var myReg=/^[a-zA-Z0-9_-]+@([a-zA-Z0-9]+\.)+(com|cn|net|org|COM|CN|NET|ORG)$/;
            var myReg = /^[A-Za-z\d]+([-_.][A-Za-z\d]+)*@([A-Za-z\d]+[-.])+[A-Za-z\d]{2,4}$/;
            if(!myReg.test(email)){
                $('#email').focus();
                layer.msg('邮箱格式不正确');
                return false;
            }
        }
        var ch = $('input[name="yhxy"]').is(':checked');
        if(!ch){
            layer.msg('请阅读并同意用户协议');
            return false;
        }
        return true;
    }
  function getCitys(province){
    $.ajax({
        url:"{:U('getCitys')}",
        data:{province:province},
        type:'post',
        success:function(result){
          var res = $.parseJSON(result);
          var html = '<option value="">请选择城市</option>';
          for (var i = 0 ; i < res.length ; i++) {
              html += "<option value='"+res[i].dic_value+"'>"+res[i].dic_value+"</option>";
          }
          $('#city').html(html);
        }
      })
  }
  //验证手机号
  function checkTel(tel){
      var reg=/^[1][3,4,5,6,7,8,9][0-9]{9}$/;
      if(reg.test(tel)){
          return true;
      }else{
          return false;
      }
  }
  //验证身份证
  function checkIdentity(identity){
        var reg = /^\d{6}(18|19|20)?\d{2}(0[1-9]|1[012])(0[1-9]|[12]\d|3[01])\d{3}(\d|[xX])$/;
        if(reg.test(identity)){
            return true;
        }else{
            return false;
        }
    }
    //验证护照号码
function checkPassport(code){
    var reg = /^((1[45]\d{7})|(G\d{8})|(P\d{7})|(S\d{7,8}))?$/;
    if(reg.test(code)){
        return true;
    }else{
        return false;
    }
}

 //点击关闭弹窗
 $(".closePopup").click(function(){
     var skipurl = "/personinfo";
     closePopup(skipurl);
 });
    </script>
</block>

